<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>BENTO Admin</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin:0;
  background:#0e0e11;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont;
}
#app { padding:16px }
.card {
  background:#1c1c22;
  border-radius:14px;
  padding:16px;
  margin-bottom:12px;
}
button {
  width:100%;
  padding:14px;
  margin-top:10px;
  border:none;
  border-radius:12px;
  background:#8774e1;
  color:white;
  font-size:16px;
}
.error {
  color:#ff6b6b;
  white-space:pre-wrap;
}
</style>
</head>

<body>
<div id="app">‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶</div>

<script>
/* ===== SAFE ERROR OUTPUT ===== */
function fatal(msg) {
  document.getElementById("app").innerHTML =
    `<div class="card error">‚ùå –û–®–ò–ë–ö–ê\n\n${msg}</div>`;
  throw new Error(msg);
}

/* ===== TELEGRAM ===== */
if (!window.Telegram || !Telegram.WebApp) {
  fatal("–ù–µ Telegram WebApp");
}
const tg = Telegram.WebApp;
tg.expand();

/* ===== USER ===== */
const user = tg.initDataUnsafe?.user;
if (!user) fatal("–ù–µ—Ç tg.initDataUnsafe.user");

/* ===== SUPABASE ===== */
if (typeof supabase === "undefined") {
  fatal("Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è");
}

const SUPABASE_URL = "https://duqqpuitipndkghpqupb.supabase.co";
const SUPABASE_KEY = "sb_publishable_gN3Tyqs65cBJ0Ra9P7l0hQ_eB413MYU";

let supabaseClient;
try {
  supabaseClient = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
  );
} catch (e) {
  fatal("createClient –æ—à–∏–±–∫–∞:\n" + e.message);
}

/* ===== CHECK ACCESS ===== */
const app = document.getElementById("app");
app.innerText = "üîé –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞‚Ä¶";

async function checkAccess() {
  let res;
  try {
    res = await supabaseClient
      .from("admins")
      .select("role")
      .eq("id", user.id)
      .single();
  } catch (e) {
    fatal("–ó–∞–ø—Ä–æ—Å —É–ø–∞–ª:\n" + e.message);
  }

  if (res.error) {
    fatal("Supabase error:\n" + res.error.message);
  }

  if (!res.data) {
    app.innerHTML = `
      <div class="card">
        ‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞<br>
        ID: ${user.id}
      </div>`;
    return;
  }

  app.innerHTML = `
    <div class="card">
      ‚úÖ –î–û–°–¢–£–ü –ï–°–¢–¨<br><br>
      ID: ${user.id}<br>
      –†–æ–ª—å: ${res.data.role}
    </div>`;
}

checkAccess();
</script>
</body>
</html>
