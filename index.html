<script>
const tg = Telegram.WebApp;
tg.expand();
const user = tg.initDataUnsafe.user;

const sb = supabase.createClient(
  "https://mynsrqebdknpceyucayb.supabase.co",
  "sb_publishable_W37lFR5w6xlYXYtUinLtjA_IEqOP-ci"
);

let ROLE="", PIN="", input="", error=false;
const app=document.getElementById("app");

/* START */
async function start(){
  const {data,error} = await sb
    .from("admins")
    .select("role,pin")
    .eq("id",user.id)
    .single();

  if(error || !data){
    app.innerHTML="‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞";
    return;
  }

  ROLE = data.role;
  PIN  = String(data.pin);
  drawPin();
}

/* ===== PIN ===== */
function drawPin(){
  app.innerHTML=`
  <div class="card">
    <div class="avatar" style="background-image:url('${user.photo_url||''}')"></div>
    <div class="user-name">${user.first_name}</div>
    <div class="user-role">${ROLE}</div>

    <div class="dots">
      ${[0,1,2,3].map(i=>`
        <div class="dot ${input[i]?'fill':''} ${error?'error':''}"></div>
      `).join("")}
    </div>

    <div class="keypad">
      ${[1,2,3,4,5,6,7,8,9,"",0,"‚å´"].map(k=>k===""?
        `<div class="key empty"></div>`:
        `<div class="key" onclick="press('${k}')">${k}</div>`
      ).join("")}
    </div>
  </div>`;
}

function press(k){
  if(k==="‚å´") input=input.slice(0,-1);
  else if(input.length<4) input+=k;

  error=false;

  if(input.length===4){
    if(input===PIN){
      showFaceID();
    }else{
      input="";
      error=true;
      drawPin();
    }
  }else{
    drawPin();
  }
}

/* ===== FACE ID ===== */
function showFaceID(){
  app.innerHTML=`
  <div class="card">
    <h3>Face ID</h3>
    <p style="color:var(--muted)">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—Ö–æ–¥</p>

    <div class="faceid">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
        <path d="M4 7V5a2 2 0 0 1 2-2h2M20 7V5a2 2 0 0 0-2-2h-2"/>
        <path d="M4 17v2a2 2 0 0 0 2 2h2M20 17v2a2 2 0 0 1-2 2h-2"/>
        <circle cx="9" cy="10" r="1"/>
        <circle cx="15" cy="10" r="1"/>
        <path d="M9 15c.8.7 1.7 1 3 1s2.2-.3 3-1"/>
      </svg>
      <div class="scan-line"></div>
    </div>

    <p style="color:var(--muted)">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ‚Ä¶</p>
  </div>`;

  setTimeout(menu,1800);
}

/* ===== MENU ===== */
function menu(){
  app.innerHTML=`
  <div class="card">
    <h2>üëë BENTO ADMIN</h2>
    <p>${user.first_name} ‚Ä¢ ${ROLE}</p>

    <button class="big-btn" onclick="adminsPanel()">üë• –ê–¥–º–∏–Ω—ã</button>
    <button class="big-btn" onclick="settings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <button class="big-btn danger" onclick="tg.close()">üö™ –í—ã–π—Ç–∏</button>
  </div>`;
}

/* ===== SETTINGS ===== */
function settings(){
  app.innerHTML=`
  <div class="card">
    <div class="back" onclick="menu()">‚Üê –ù–∞–∑–∞–¥</div>
    <button class="big-btn" onclick="toggleTheme()">üåó –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
  </div>`;
}

/* ===== ADMINS ===== */
async function adminsPanel(){
  const {data}=await sb.from("admins").select("*");

  app.innerHTML=`
  <div class="card">
    <div class="back" onclick="menu()">‚Üê –ù–∞–∑–∞–¥</div>

    <input id="newId" placeholder="Telegram ID" class="key" style="width:100%;margin-bottom:10px">
    <button class="big-btn" onclick="addAdmin()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞</button>

    <div style="margin-top:20px;text-align:left">
      ${data.map(a=>`
        <div style="padding:10px;border-bottom:1px solid var(--stroke)">
          <b>ID ${a.id}</b> ‚Äî ${a.role}
          ${a.role!=="OWNER"?
            `<span style="float:right;color:var(--danger);cursor:pointer"
             onclick="removeAdmin(${a.id})">‚úñ</span>`:""}
        </div>
      `).join("")}
    </div>
  </div>`;
}

async function addAdmin(){
  const id=document.getElementById("newId").value;
  if(!id) return;

  await sb.from("admins").insert({
    id:Number(id),
    role:"ADMIN",
    pin:"0000"
  });

  adminsPanel();
}

async function removeAdmin(id){
  await sb.from("admins").delete().eq("id",id);
  adminsPanel();
}

start();
</script>
